<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapeador de Planilhas Excel</title>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Ubuntu', sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d4a3e 50%, #1a1a1a 100%);
            min-height: 100vh;
            color: #ffffff;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(45deg, #90EE90, #98FB98);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 300;
        }

        .upload-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            overflow: hidden;
            border-radius: 15px;
            background: linear-gradient(45deg, #90EE90, #98FB98);
            padding: 2px;
            transition: all 0.3s ease;
            margin-right: 15px;
        }

        .file-input-wrapper:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(144, 238, 144, 0.3);
        }

        .file-input {
            position: absolute;
            left: -9999px;
        }

        .file-input-button {
            display: block;
            padding: 15px 30px;
            background: rgba(26, 26, 26, 0.9);
            color: #90EE90;
            border: none;
            border-radius: 13px;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input-button:hover {
            background: rgba(26, 26, 26, 0.7);
        }

        .download-xml-btn {
            background: linear-gradient(45deg, #4A90E2, #5BA3F5);
            border: none;
            border-radius: 15px;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 500;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
            text-decoration: none;
            display: inline-block;
        }

        .download-xml-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(74, 144, 226, 0.4);
        }

        .file-info {
            margin-top: 15px;
            padding: 10px;
            background: rgba(144, 238, 144, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(144, 238, 144, 0.3);
            display: none;
        }

        .mapping-section {
            display: none;
        }

        .mapping-title {
            font-size: 1.5rem;
            font-weight: 500;
            margin-bottom: 20px;
            color: #90EE90;
        }

        .column-list {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #90EE90 rgba(255, 255, 255, 0.1);
        }

        .column-list::-webkit-scrollbar {
            width: 8px;
        }

        .column-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .column-list::-webkit-scrollbar-thumb {
            background-color: #90EE90;
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .column-list h3 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #98FB98;
        }

        .column-item {
            padding: 10px 15px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .column-item:hover {
            background: rgba(144, 238, 144, 0.2);
            transform: translateX(5px);
        }

        .column-item.selected {
            background: rgba(144, 238, 144, 0.3);
            border-color: #90EE90;
        }

        .column-item.mapped {
            background: rgba(0, 128, 0, 0.4);
            border-color: #32CD32;
            color: #e0ffe0;
            font-weight: 500;
        }

        /* Estilo para campos obrigat√≥rios */
        .column-item.required {
            background: rgba(255, 0, 0, 0.2);
            border-color: #ff4444;
            color: #ffcccc;
            font-weight: 600;
            position: relative;
        }

        .column-item.required::before {
            content: "‚òÖ ";
            color: #ff4444;
            font-weight: bold;
        }

        .column-item.required:hover {
            background: rgba(255, 0, 0, 0.3);
            border-color: #ff6666;
        }

        .column-item.required.mapped {
            background: rgba(255, 165, 0, 0.4);
            border-color: #ffa500;
            color: #ffe4b5;
        }

        .mapping-pairs {
            margin-top: 20px;
        }

        /* Estilos para a tabela de dados */
        .data-table-container {
            margin: 20px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.2);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .data-table th {
            background: rgba(144, 238, 144, 0.2);
            color: #98FB98;
            padding: 12px 8px;
            text-align: left;
            font-weight: 500;
            border-bottom: 2px solid rgba(144, 238, 144, 0.3);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* Estilo para colunas obrigat√≥rias na tabela */
        .data-table th.required-column {
            background: rgba(255, 0, 0, 0.3);
            color: #ffcccc;
            border-bottom: 2px solid #ff4444;
            font-weight: 600;
            position: relative;
        }

        .data-table th.required-column::before {
            content: "‚òÖ ";
            color: #ff4444;
            font-weight: bold;
        }

        .data-table td.required-column {
            background: rgba(255, 0, 0, 0.1);
            border-left: 2px solid rgba(255, 68, 68, 0.3);
            border-right: 2px solid rgba(255, 68, 68, 0.3);
        }

        .data-table td.required-column input {
            background: rgba(255, 0, 0, 0.05);
            border-color: rgba(255, 68, 68, 0.2);
        }

        .data-table td.required-column input:focus {
            background: rgba(255, 0, 0, 0.1);
            border-color: #ff4444;
        }

        .data-table td {
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
        }

        .data-table tr:hover {
            background: rgba(144, 238, 144, 0.1);
        }

        .data-table input {
            width: 100%;
            background: transparent;
            border: 1px solid transparent;
            color: inherit;
            padding: 4px 6px;
            border-radius: 4px;
            font-size: inherit;
            transition: all 0.3s ease;
        }

        .data-table input:focus {
            background: rgba(144, 238, 144, 0.1);
            border-color: #90EE90;
            outline: none;
        }

        .data-table input:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(144, 238, 144, 0.5);
        }

        /* Controles de pagina√ß√£o */
        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .pagination-info {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }

        .pagination-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pagination-btn {
            background: rgba(144, 238, 144, 0.2);
            border: 1px solid rgba(144, 238, 144, 0.3);
            color: #98FB98;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .pagination-btn:hover:not(:disabled) {
            background: rgba(144, 238, 144, 0.3);
            transform: translateY(-2px);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .page-input-container {
            margin: 0 8px;
        }

        .page-input-container input {
            width: 60px;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(144, 238, 144, 0.3);
            color: #98FB98;
            padding: 6px;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .page-input-container input:focus {
            background: rgba(144, 238, 144, 0.1);
            border-color: #90EE90;
            outline: none;
        }

        .mapping-pair {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: rgba(144, 238, 144, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(144, 238, 144, 0.3);
        }

        .mapping-pair .remove-btn {
            background: rgba(255, 100, 100, 0.8);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mapping-pair .remove-btn:hover {
            background: rgba(255, 100, 100, 1);
            transform: scale(1.1);
        }

        .export-section {
            display: none;
            text-align: center;
        }

        .export-btn {
            background: linear-gradient(45deg, #90EE90, #98FB98);
            border: none;
            border-radius: 15px;
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: 500;
            color: #1a1a1a;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(144, 238, 144, 0.3);
        }

        .export-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(144, 238, 144, 0.4);
        }

        .export-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #90EE90, #98FB98);
            width: 0%;
            transition: width 0.3s ease;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }

        .step {
            display: flex;
            align-items: center;
            margin: 0 15px;
        }

        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .step.active .step-number {
            background: linear-gradient(45deg, #90EE90, #98FB98);
            color: #1a1a1a;
        }

        .step.completed .step-number {
            background: #90EE90;
            color: #1a1a1a;
        }

        /* Estilos para se√ß√µes recolh√≠veis */
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .collapsible-header h2 {
            margin: 0;
        }

        .collapsible-header .arrow {
            font-size: 1.5rem;
            transition: transform 0.3s ease;
        }

        .collapsible-header.collapsed .arrow {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out, padding 0.5s ease-out;
            padding-top: 0;
        }

        .collapsible-content.expanded {
            max-height: 2000px;
            padding-top: 15px;
        }

        .mapping-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        /* Estilos para preenchimento em lote */
        .bulk-fill-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .bulk-fill-title {
            font-size: 1.2rem;
            color: #98FB98;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .bulk-fill-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }

        .bulk-fill-input {
            flex: 1;
            min-width: 200px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(144, 238, 144, 0.3);
            color: #1a1a1a; /* Alterado para uma cor escura para melhor visibilidade */
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .bulk-fill-input:focus {
            background: rgba(144, 238, 144, 0.1);
            border-color: #90EE90;
            outline: none;
        }

        .bulk-fill-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .bulk-fill-btn {
            background: rgba(144, 238, 144, 0.2);
            border: 1px solid rgba(144, 238, 144, 0.3);
            color: #98FB98;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            font-weight: 500;
        }

        .bulk-fill-btn:hover:not(:disabled) {
            background: rgba(144, 238, 144, 0.3);
            transform: translateY(-2px);
        }

        .bulk-fill-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .column-selector {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(144, 238, 144, 0.3);
            color: #1a1a1a; /* Alterado para uma cor escura para melhor visibilidade */
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.95rem;
            min-width: 200px;
        }

        .column-selector:focus {
            background: rgba(144, 238, 144, 0.1);
            border-color: #90EE90;
            outline: none;
        }

        .bulk-fill-info {
            background: rgba(144, 238, 144, 0.1);
            border: 1px solid rgba(144, 238, 144, 0.3);
            border-radius: 8px;
            padding: 10px 15px;
            margin-top: 10px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .bulk-fill-info strong {
            color: #98FB98;
        }

        @media (max-width: 768px) {
            .mapping-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .container {
                padding: 15px;
            }

            .bulk-fill-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .bulk-fill-input,
            .column-selector {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Mapeador de Planilhas Excel</h1>
            <p>Importe sua planilha, mapeie os campos e exporte para TXT</p>
        </div>

        <div class="step-indicator">
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <span>Importar</span>
            </div>
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <span>Mapear</span>
            </div>
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <span>Exportar</span>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <!-- Se√ß√£o de Upload -->
        <div class="glass-card" id="uploadSectionCard">
            <div class="collapsible-header" id="uploadHeader">
                <h2 class="mapping-title">1. Selecione sua planilha Excel</h2>
                <span class="arrow">‚ñº</span>
            </div>
            <div class="collapsible-content" id="uploadContent">
                <div class="upload-section">
                    <div class="file-input-wrapper">
                        <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.xlsm">
                        <label for="fileInput" class="file-input-button">
                            üìÅ Escolher Arquivo Excel
                        </label>
                    </div>
                    <a href="Conj_Dados_Bens_Patrionio.xml" download class="download-xml-btn">
                        üì• Download Conj_Dados_Bens_Patrionio.xml
                    </a>
                    <div class="file-info" id="fileInfo">
                        <p><strong>Arquivo selecionado:</strong> <span id="fileName"></span></p>
                        <p><strong>Tamanho:</strong> <span id="fileSize"></span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o de Mapeamento -->
        <div class="glass-card" id="mappingSectionCard">
            <div class="collapsible-header collapsed" id="mappingHeader">
                <h2 class="mapping-title">2. Mapeie os campos</h2>
                <span class="arrow">‚ñº</span>
            </div>
            <div class="collapsible-content" id="mappingContent">
                <p style="margin-bottom: 20px; color: rgba(255, 255, 255, 0.8);">
                    Clique em uma coluna da sua planilha e depois em um campo modelo para criar o mapeamento.
                </p>
                
                <!-- Legenda das cores -->
                <div style="background: rgba(255, 255, 255, 0.05); border-radius: 10px; padding: 15px; margin-bottom: 20px; border: 1px solid rgba(255, 255, 255, 0.1);">
                    <h4 style="color: #98FB98; margin-bottom: 10px; font-size: 1rem;">Legenda:</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 15px; font-size: 0.9rem;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="display: inline-block; width: 20px; height: 15px; background: rgba(255, 0, 0, 0.2); border: 1px solid #ff4444; border-radius: 3px;"></span>
                            <span style="color: #ffcccc;">‚òÖ Campos Obrigat√≥rios</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="display: inline-block; width: 20px; height: 15px; background: rgba(0, 128, 0, 0.4); border: 1px solid #32CD32; border-radius: 3px;"></span>
                            <span style="color: #e0ffe0;">Campos Mapeados</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="display: inline-block; width: 20px; height: 15px; background: rgba(255, 165, 0, 0.4); border: 1px solid #ffa500; border-radius: 3px;"></span>
                            <span style="color: #ffe4b5;">Obrigat√≥rios Mapeados</span>
                        </div>
                    </div>
                </div>
                
                <div class="mapping-grid">
                    <div class="column-list">
                        <h3>Colunas da sua planilha</h3>
                        <div id="excelColumns"></div>
                    </div>
                    
                    <div class="column-list">
                        <h3>Campos modelo (planilhamodelo.xlsm)</h3>
                        <div id="modelColumns"></div>
                    </div>
                </div>

                <div class="mapping-pairs">
                    <h3 style="color: #98FB98; margin-bottom: 15px;">Mapeamentos criados:</h3>
                    <div id="mappingPairs"></div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o de Exporta√ß√£o -->
        <div class="glass-card" id="exportSectionCard">
            <div class="collapsible-header collapsed" id="exportHeader">
                <h2 class="mapping-title">3. Exportar dados</h2>
                <span class="arrow">‚ñº</span>
            </div>
            <div class="collapsible-content" id="exportContent">
                <p style="margin-bottom: 20px; color: rgba(255, 255, 255, 0.8);">
                    Visualize e edite os dados antes de exportar. Use os bot√µes de navega√ß√£o para percorrer as p√°ginas.
                </p>
                
                <!-- Se√ß√£o de Preenchimento em Lote -->
                <div class="bulk-fill-section" id="bulkFillSection" style="display: none;">
                    <div class="bulk-fill-title">
                        üîß Preenchimento em Lote
                    </div>
                    <div class="bulk-fill-controls">
                        <select class="column-selector" id="columnSelector">
                            <option value="">Selecione uma coluna...</option>
                        </select>
                        <input type="text" class="bulk-fill-input" id="bulkFillValue" placeholder="Digite o valor para preencher...">
                        <button class="bulk-fill-btn" id="fillEmptyBtn" onclick="fillEmptyFields()">
                            Preencher Vazios
                        </button>
                        <button class="bulk-fill-btn" id="fillAllBtn" onclick="fillAllFields()">
                            Preencher Todos
                        </button>
                    </div>
                    <div class="bulk-fill-info" id="bulkFillInfo" style="display: none;">
                        <strong>Dica:</strong> Use "Preencher Vazios" para preencher apenas campos em branco, ou "Preencher Todos" para substituir todos os valores da coluna selecionada.
                    </div>
                </div>
                
                <!-- Tabela de dados -->
                <div class="data-table-container" id="dataTableContainer" style="display: none;">
                    <div class="table-wrapper">
                        <table class="data-table" id="dataTable">
                            <thead id="tableHeader"></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                    
                    <!-- Controles de pagina√ß√£o -->
                    <div class="pagination-controls">
                        <div class="pagination-info">
                            <span id="paginationInfo">P√°gina 1 de 1 (0 registros)</span>
                        </div>
                        <div class="pagination-buttons">
                            <button class="pagination-btn" id="firstPageBtn" onclick="goToPage(1)">‚èÆÔ∏è</button>
                            <button class="pagination-btn" id="prevPageBtn" onclick="goToPage(currentPage - 1)">‚óÄÔ∏è</button>
                            <span class="page-input-container">
                                <input type="number" id="pageInput" min="1" value="1" onchange="goToPage(parseInt(this.value))">
                            </span>
                            <button class="pagination-btn" id="nextPageBtn" onclick="goToPage(currentPage + 1)">‚ñ∂Ô∏è</button>
                            <button class="pagination-btn" id="lastPageBtn" onclick="goToPage(totalPages)">‚è≠Ô∏è</button>
                        </div>
                    </div>
                </div>
                
                <button class="export-btn" id="exportBtn" onclick="exportToTxt()">
                    üìÑ Gerar arquivo TXT
                </button>
                <div id="exportStatus" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <script>
        // Campos modelo baseados na planilha analisada
        const modelFields = [
            'CODIGO EMPRESA', 'COD BEM', 'IDENTIFICADOR', 'DESCRI√á√ÉO', 'Data Aquisi√ß√£o',
            'Data baixa', 'CONTA PATRIMONIAL', 'CENTRO DE CUSTO', 'HISTORICO', 'TIPO (B)',
            'CLASSIFICA√á√ÉO (I)', 'VINCULADO A', 'ORIUNDO DO ATIVO CIRCULANTE', 'FUN√á√ÉO',
            'VLR DA AQUISI√á√ÉO', 'ALIQUOTA ICMS', 'VLR DO ICMS', 'VLR ICMS - SUBST TRIB',
            'VLR ICMS - DIF ALIQUOTA', 'VLR ICMS S FRETE', 'VALOR TOT DO CRED DO ICMS',
            'ALIQUOTA PIS', 'VLR DO CRED PIS', 'ALIQUOTA COFINS', 'VLR CRED COFINS',
            'VLR ORIGINAL', 'CORRE√á√ÉO MON  ACUM', 'VLR RESIDUAL', 'BASE DE CALC DA DEPREC',
            'CALC CRED ICMS', 'CALC CRED PIS E COFINS', 'DEPRECIAR BEM (S/N)',
            'CALC FISCAL DEPREC - 100% NO M√äS INICIO DEPREC', 'CALC FISCAL - DATA INICIO',
            'CALC FISCAL - INFO DEPREC ACUM AT√â (S/N)', 'CALC FISCAL - INFO DEPREC ACUM ATE (DATA)',
            'CALC FISCAL VLR DEPREC ACUM', 'CALC FISCAL TX ALTERNATIVA',
            'CALC SOCIE DATA INICIO', 'CALC SOCIETARIO - INFO DEPREC ACUM AT√â',
            'CALC SOCIE - DEPREC ACUM ATE', 'CALC SOCIE - VLR DEPREC ACUM',
            'CALC SOCIE - TX INICIAL', 'DOC FISCAL - NUMERO', 'DOC FISCAL - SERIE',
            'DOC FISCAL - DATA EMISS√ÉO', 'DOC FISCAL - ESPECIE', 'DOC FISCAL - CHAVE NFE',
            'DOC FISCAL - FORN', 'DOC FISCAL - EMITENTE', 'DOC FISCAL PROD',
            'DOC FISCAL - SEQUENCIAL DO ITEM', 'APROPIAR CRED SOMENTE BEM RESULT',
            'CRED ICMS PRO CARGAS', 'PROD AQUIQ ESTADO',
            'UTIL CRED ICMS M√äS DE INICIO EFETIVO ATIV', 'M√äS INICIO EFETIVO ATIV',
            'RECOLHER DEBITO ICMS', 'PIS E COFINS CALC COM BASE ENC DE DEPREC',
            'PIS E COFINS CALC BASE VLR AQUIS', 'PIS COFINS INICIO CALC',
            'PIS COFINS ORIGEM BEM', 'PIS COFINS BASE CREDITO', 'PIS COFINS ESPECIE',
            'PIS COFINS TIPO UTILIZADO', 'PIS COFINS BASE CALC', 'PIS COFINS PEIODO CALC',
            'PIS E COFINS CST', 'PIS E COFINS VINC DO CREDITO', 'PIS E COFINS DESC COMPLEM',
            'PIS E COFINS POSSUI PROCESSO REFER', 'PIS E COFINS IDENT',
            'PIS E COFINS ORIGEM', 'PIS E COFINS SE√á√ÉO JURIDICA', 'PIS E COFINS VARA',
            'PIS E COFINS NAT DA A√á√ÉO', 'PIS E COFINS DATA DA SENT OU DESPACHO',
            'PIS E COFINS DESCRI√á√ÉO DO PROCESSO', 'DATA DE CAD DO BEM',
            'QUANTIDADE DO BEM'
        ];

        // Campos obrigat√≥rios destacados em vermelho
        const requiredFields = [
            'CODIGO EMPRESA', 'COD BEM', 'IDENTIFICADOR', 'DESCRI√á√ÉO', 'Data Aquisi√ß√£o',
            'CONTA PATRIMONIAL', 'CENTRO DE CUSTO', 'HISTORICO', 'TIPO (B)', 'CLASSIFICA√á√ÉO (I)',
            'FUN√á√ÉO', 'VLR DA AQUISI√á√ÉO', 'VLR ORIGINAL', 'BASE DE CALC DA DEPREC',
            'CALC FISCAL - DATA INICIO', 'CALC FISCAL TX ALTERNATIVA', 'DATA DE CAD DO BEM',
            'QUANTIDADE DO BEM', 'DEPRECIAR BEM (S/N)'
        ];

        let excelData = null;
        let excelColumns = [];
        let mappings = {};
        let selectedExcelColumn = null;
        let selectedModelColumn = null;
        
        // Vari√°veis para pagina√ß√£o
        let processedData = [];
        let currentPage = 1;
        let totalPages = 1;
        const itemsPerPage = 20;

        // Fun√ß√µes para recolher/expandir se√ß√µes
        function toggleCollapsible(headerId, contentId) {
            const header = document.getElementById(headerId);
            const content = document.getElementById(contentId);
            header.classList.toggle('collapsed');
            content.classList.toggle('expanded');
        }

        // Event listeners para se√ß√µes recolh√≠veis
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('uploadHeader').addEventListener('click', function() {
                toggleCollapsible('uploadHeader', 'uploadContent');
            });
            
            document.getElementById('mappingHeader').addEventListener('click', function() {
                toggleCollapsible('mappingHeader', 'mappingContent');
            });
            
            document.getElementById('exportHeader').addEventListener('click', function() {
                toggleCollapsible('exportHeader', 'exportContent');
            });
            
            // Inicializar com primeira se√ß√£o expandida
            document.getElementById('uploadContent').classList.add('expanded');
        });

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB';
                document.getElementById('fileInfo').style.display = 'block';
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    excelData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    
                    if (excelData.length > 0) {
                        excelColumns = excelData[0];
                        displayColumns();
                        updateProgress(33);
                        updateSteps(2);
                        toggleCollapsible('mappingHeader', 'mappingContent');
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        });

        function displayColumns() {
            const excelColumnsDiv = document.getElementById("excelColumns");
            const modelColumnsDiv = document.getElementById("modelColumns");
            
            // Limpar conte√∫do anterior
            excelColumnsDiv.innerHTML = "";
            modelColumnsDiv.innerHTML = "";
            
            // Mostrar colunas do Excel
            excelColumns.forEach(column => {
                const div = document.createElement("div");
                div.className = "column-item";
                div.textContent = column;
                div.onclick = () => selectExcelColumn(column);
                excelColumnsDiv.appendChild(div);
            });
            
            // Mostrar campos modelo
            modelFields.forEach(field => {
                const div = document.createElement("div");
                div.className = "column-item";
                
                // Verificar se √© campo obrigat√≥rio
                if (requiredFields.includes(field)) {
                    div.classList.add("required");
                }
                
                div.textContent = field;
                div.onclick = () => selectModelColumn(field);
                modelColumnsDiv.appendChild(div);
            });
        }

        function selectExcelColumn(column) {
            clearSelections();
            selectedExcelColumn = column;
            
            // Destacar coluna selecionada
            document.querySelectorAll("#excelColumns .column-item").forEach(item => {
                if (item.textContent === column) {
                    item.classList.add("selected");
                }
            });
            
            // Se j√° tiver um campo modelo selecionado, criar mapeamento
            if (selectedModelColumn) {
                createMapping();
            }
        }

        function selectModelColumn(field) {
            selectedModelColumn = field;
            
            // Destacar campo selecionado
            document.querySelectorAll("#modelColumns .column-item").forEach(item => {
                if (item.textContent === field) {
                    item.classList.add("selected");
                }
            });
            
            // Se j√° tiver uma coluna Excel selecionada, criar mapeamento
            if (selectedExcelColumn) {
                createMapping();
            }
        }

        function createMapping() {
            if (selectedExcelColumn && selectedModelColumn) {
                // Verificar se o campo modelo j√° est√° mapeado
                if (mappings[selectedModelColumn]) {
                    if (!confirm(`O campo "${selectedModelColumn}" j√° est√° mapeado para "${mappings[selectedModelColumn]}". Deseja substituir?`)) {
                        clearSelections();
                        return;
                    }
                }
                
                mappings[selectedModelColumn] = selectedExcelColumn;
                displayMappings();
                updateColumnDisplays();
                clearSelections();
            }
        }

        function displayMappings() {
            const mappingPairsDiv = document.getElementById("mappingPairs");
            mappingPairsDiv.innerHTML = "";
            
            Object.entries(mappings).forEach(([modelField, excelColumn]) => {
                const div = document.createElement("div");
                div.className = "mapping-pair";
                div.innerHTML = `
                    <span><strong>${modelField}</strong> ‚Üê ${excelColumn}</span>
                    <button class="remove-btn" onclick="removeMapping('${modelField}')">√ó</button>
                `;
                mappingPairsDiv.appendChild(div);
            });
            
            // Mostrar se√ß√£o de exporta√ß√£o se houver mapeamentos
            if (Object.keys(mappings).length > 0) {
                toggleCollapsible("exportHeader", "exportContent");
                processDataForTable();
                displayDataTable();
                setupBulkFillSection();
                updateProgress(66);
                updateSteps(3);
            }
        }

        function removeMapping(modelField) {
            delete mappings[modelField];
            displayMappings();
            updateColumnDisplays();
            
            if (Object.keys(mappings).length === 0) {
                document.getElementById("dataTableContainer").style.display = "none";
                document.getElementById("bulkFillSection").style.display = "none";
            }
        }

        function updateColumnDisplays() {
            // Atualizar display das colunas Excel
            document.querySelectorAll("#excelColumns .column-item").forEach(item => {
                const column = item.textContent;
                const isMapped = Object.values(mappings).includes(column);
                if (isMapped) {
                    item.classList.add("mapped");
                } else {
                    item.classList.remove("mapped");
                }
            });
            
            // Atualizar display dos campos modelo
            document.querySelectorAll("#modelColumns .column-item").forEach(item => {
                const field = item.textContent;
                
                // Remover classes existentes (exceto required)
                item.classList.remove("mapped");
                
                // Verificar se √© campo obrigat√≥rio
                if (requiredFields.includes(field)) {
                    item.classList.add("required");
                }
                
                // Verificar se est√° mapeado
                if (mappings[field]) {
                    item.classList.add("mapped");
                }
            });
        }

        function clearSelections() {
            selectedExcelColumn = null;
            selectedModelColumn = null;
            
            document.querySelectorAll(".column-item").forEach(item => {
                item.classList.remove("selected");
            });
        }

        function processDataForTable() {
            if (!excelData || excelData.length <= 1) return;
            
            processedData = [];
            const dataRows = excelData.slice(1); // Pular cabe√ßalho
            
            dataRows.forEach(row => {
                const processedRow = {};
                
                // Inicializar todos os campos modelo
                modelFields.forEach(field => {
                    processedRow[field] = '';
                });
                
                // Preencher campos mapeados
                Object.entries(mappings).forEach(([modelField, excelField]) => {
                    const excelColumnIndex = excelColumns.indexOf(excelField);
                    if (excelColumnIndex !== -1 && row[excelColumnIndex] !== undefined) {
                        processedRow[modelField] = row[excelColumnIndex] || '';
                    }
                });
                
                processedData.push(processedRow);
            });
            
            // Calcular pagina√ß√£o
            totalPages = Math.ceil(processedData.length / itemsPerPage);
            currentPage = 1;
        }

        function displayDataTable() {
            const tableContainer = document.getElementById("dataTableContainer");
            const tableHeader = document.getElementById("tableHeader");
            const tableBody = document.getElementById("tableBody");
            
            if (processedData.length === 0) {
                tableContainer.style.display = "none";
                return;
            }
            
            tableContainer.style.display = "block";
            
            // Criar cabe√ßalho da tabela
            tableHeader.innerHTML = "";
            const headerRow = document.createElement("tr");
            modelFields.forEach(field => {
                const th = document.createElement("th");
                th.textContent = field;
                th.style.minWidth = "150px";
                
                // Verificar se √© campo obrigat√≥rio e aplicar classe
                if (requiredFields.includes(field)) {
                    th.classList.add("required-column");
                }
                
                headerRow.appendChild(th);
            });
            tableHeader.appendChild(headerRow);
            
            // Mostrar p√°gina atual
            displayCurrentPage();
            updatePaginationControls();
        }

        function displayCurrentPage() {
            const tableBody = document.getElementById("tableBody");
            tableBody.innerHTML = "";
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, processedData.length);
            
            for (let i = startIndex; i < endIndex; i++) {
                const rowData = processedData[i];
                const tr = document.createElement("tr");
                
                modelFields.forEach(field => {
                    const td = document.createElement("td");
                    const input = document.createElement("input");
                    input.type = "text";
                    input.value = rowData[field] || '';
                    input.onchange = function() {
                        processedData[i][field] = this.value;
                    };
                    
                    // Verificar se √© campo obrigat√≥rio e aplicar classe
                    if (requiredFields.includes(field)) {
                        td.classList.add("required-column");
                    }
                    
                    td.appendChild(input);
                    tr.appendChild(td);
                });
                
                tableBody.appendChild(tr);
            }
        }

        function updatePaginationControls() {
            const paginationInfo = document.getElementById('paginationInfo');
            const pageInput = document.getElementById('pageInput');
            const firstPageBtn = document.getElementById('firstPageBtn');
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const lastPageBtn = document.getElementById('lastPageBtn');

            // Atualizar informa√ß√µes
            paginationInfo.textContent = `P√°gina ${currentPage} de ${totalPages} (${processedData.length} registros)`;
            pageInput.value = currentPage;
            pageInput.max = totalPages;

            // Atualizar estado dos bot√µes
            firstPageBtn.disabled = currentPage === 1;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
            lastPageBtn.disabled = currentPage === totalPages;
        }

        function goToPage(page) {
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            displayCurrentPage();
            updatePaginationControls();
        }

        // Configurar se√ß√£o de preenchimento em lote
        function setupBulkFillSection() {
            const bulkFillSection = document.getElementById("bulkFillSection");
            const columnSelector = document.getElementById("columnSelector");
            const bulkFillInfo = document.getElementById("bulkFillInfo");
            
            bulkFillSection.style.display = "block";
            bulkFillInfo.style.display = "block";
            
            // Limpar e popular seletor de colunas
            columnSelector.innerHTML = '<option value="">Selecione uma coluna...</option>';
            
            modelFields.forEach(field => {
                const option = document.createElement("option");
                option.value = field;
                option.textContent = field;
                columnSelector.appendChild(option);
            });
        }

        // Fun√ß√£o para preencher campos vazios
        function fillEmptyFields() {
            const columnSelector = document.getElementById("columnSelector");
            const bulkFillValue = document.getElementById("bulkFillValue");
            
            const selectedColumn = columnSelector.value;
            const fillValue = bulkFillValue.value;
            
            if (!selectedColumn) {
                alert("Por favor, selecione uma coluna.");
                return;
            }
            
            if (fillValue === "") {
                alert("Por favor, digite um valor para preencher.");
                return;
            }
            
            let filledCount = 0;
            
            // Preencher apenas campos vazios
            processedData.forEach(row => {
                if (!row[selectedColumn] || row[selectedColumn].toString().trim() === '') {
                    row[selectedColumn] = fillValue;
                    filledCount++;
                }
            });
            
            // Atualizar tabela
            displayCurrentPage();
            
            alert(`${filledCount} campos vazios foram preenchidos na coluna "${selectedColumn}".`);
        }

        // Fun√ß√£o para preencher todos os campos
        function fillAllFields() {
            const columnSelector = document.getElementById("columnSelector");
            const bulkFillValue = document.getElementById("bulkFillValue");
            
            const selectedColumn = columnSelector.value;
            const fillValue = bulkFillValue.value;
            
            if (!selectedColumn) {
                alert("Por favor, selecione uma coluna.");
                return;
            }
            
            if (fillValue === "") {
                alert("Por favor, digite um valor para preencher.");
                return;
            }
            
            if (!confirm(`Tem certeza que deseja substituir TODOS os valores da coluna "${selectedColumn}"?`)) {
                return;
            }
            
            // Preencher todos os campos
            processedData.forEach(row => {
                row[selectedColumn] = fillValue;
            });
            
            // Atualizar tabela
            displayCurrentPage();
            
            alert(`Todos os ${processedData.length} registros foram preenchidos na coluna "${selectedColumn}".`);
        }

        function updateProgress(percentage) {
            document.getElementById('progressFill').style.width = percentage + '%';
        }

        function updateSteps(activeStep) {
            for (let i = 1; i <= 3; i++) {
                const step = document.getElementById(`step${i}`);
                step.classList.remove('active', 'completed');
                
                if (i < activeStep) {
                    step.classList.add('completed');
                } else if (i === activeStep) {
                    step.classList.add('active');
                }
            }
        }

        async function exportToTxt() {
            if (!processedData || processedData.length === 0) {
                alert('Por favor, importe um arquivo e crie pelo menos um mapeamento.');
                return;
            }

            const exportBtn = document.getElementById('exportBtn');
            const exportStatus = document.getElementById('exportStatus');
            
            exportBtn.disabled = true;
            exportStatus.innerHTML = '<p style="color: #90EE90;">Gerando arquivo...</p>';

            try {
                // Usar os dados editados da tabela
                const header = Object.keys(processedData[0]);
                
                // Filtrar linhas que n√£o est√£o completamente vazias
                const validRows = [];
                processedData.forEach(rowData => {
                    const row = [];
                    let hasValue = false;
                    
                    header.forEach(field => {
                        const value = (rowData[field] || '').toString().trim();
                        row.push(value);
                        if (value !== '') {
                            hasValue = true;
                        }
                    });
                    
                    // S√≥ adicionar a linha se ela tiver pelo menos um valor
                    if (hasValue) {
                        validRows.push(row);
                    }
                });
                
                // Gerar conte√∫do TXT apenas com linhas v√°lidas
                let txtContent = '';
                validRows.forEach(row => {
                    txtContent += row.join(';') + '\n';
                });
                
                // Remover linhas vazias no final do arquivo
                txtContent = txtContent.replace(/\n+$/, '\n');

                // Verificar se o navegador suporta File System Access API
                if ('showSaveFilePicker' in window) {
                    try {
                        // Usar File System Access API para Save As
                        const fileHandle = await window.showSaveFilePicker({
                            suggestedName: 'cad_bens.txt',
                            types: [{
                                description: 'Arquivos de texto',
                                accept: { 'text/plain': ['.txt'] }
                            }]
                        });

                        // Converter para codifica√ß√£o ANSI (Windows-1252)
                        const encoder = new TextEncoder('windows-1252', { NONSTANDARD_allowLegacyEncoding: true });
                        let encodedContent;
                        
                        try {
                            // Tentar usar TextEncoder com windows-1252
                            encodedContent = encoder.encode(txtContent);
                        } catch (e) {
                            // Fallback: converter manualmente caracteres especiais para ANSI
                            const ansiContent = txtContent
                                .replace(/[√†√°√¢√£√§]/g, 'a')
                                .replace(/[√Ä√Å√Ç√É√Ñ]/g, 'A')
                                .replace(/[√®√©√™√´]/g, 'e')
                                .replace(/[√à√â√ä√ã]/g, 'E')
                                .replace(/[√¨√≠√Æ√Ø]/g, 'i')
                                .replace(/[√å√ç√é√è]/g, 'I')
                                .replace(/[√≤√≥√¥√µ√∂]/g, 'o')
                                .replace(/[√í√ì√î√ï√ñ]/g, 'O')
                                .replace(/[√π√∫√ª√º]/g, 'u')
                                .replace(/[√ô√ö√õ√ú]/g, 'U')
                                .replace(/[√ß]/g, 'c')
                                .replace(/[√á]/g, 'C')
                                .replace(/[√±]/g, 'n')
                                .replace(/[√ë]/g, 'N');
                            
                            encodedContent = new TextEncoder().encode(ansiContent);
                        }

                        const writable = await fileHandle.createWritable();
                        await writable.write(encodedContent);
                        await writable.close();

                        exportStatus.innerHTML = '<p style="color: #90EE90;">‚úÖ Arquivo exportado com sucesso!</p>';
                        updateProgress(100);
                    } catch (error) {
                        if (error.name === 'AbortError') {
                            exportStatus.innerHTML = '<p style="color: #ffaa00;">‚ö†Ô∏è Exporta√ß√£o cancelada pelo usu√°rio.</p>';
                        } else {
                            // Fallback para download tradicional
                            downloadFallback(txtContent);
                        }
                    }
                } else {
                    // Fallback para navegadores que n√£o suportam File System Access API
                    downloadFallback(txtContent);
                }
            } catch (error) {
                console.error('Erro na exporta√ß√£o:', error);
                exportStatus.innerHTML = '<p style="color: #ff6666;">‚ùå Erro ao exportar arquivo.</p>';
            } finally {
                exportBtn.disabled = false;
            }
        }

        function downloadFallback(txtContent) {
            // M√©todo tradicional de download
            const blob = new Blob([txtContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'cad_bens.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            document.getElementById('exportStatus').innerHTML = '<p style="color: #90EE90;">‚úÖ Download iniciado!</p>';
            updateProgress(100);
        }
    </script>
</body>
</html>
